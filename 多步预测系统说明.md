# ARIMA+GARCH多步预测系统说明文档

## 概述

`run_arima_garch_jpy_last150test.py` 是一个专门用于美元兑日元汇率预测的高级时间序列分析系统，支持多种预测步长和模型类型。

## 🚀 主要功能

### 1. 多步预测支持
- **预测步长**: 1天、24天、30天、60天、90天、180天
- **预测模式**: 递归多步预测，从对数收益率重构价格水平
- **评估指标**: MSE、RMSE、MAE、MAX_AE、MAPE、R²

### 2. 模型支持

#### 2.1 朴素基线模型
- **Naive Baseline**: 使用前一天的价格作为所有未来预测

#### 2.2 纯时间序列模型
- **Pure ARMA(p,q)**: 纯自回归移动平均模型

#### 2.3 GARCH族模型

**Constant均值模型组:**
- `ARCH(1)_Const`: 常数均值 + ARCH(1)方差
- `GARCH(1,1)_Const`: 常数均值 + GARCH(1,1)方差  
- `EGARCH(1,1)_Const`: 常数均值 + EGARCH(1,1)方差
- `GARCH-M(1,1)_Const`: 常数均值-方差 + GARCH(1,1)
- `GJR-GARCH(1,1)_Const`: 常数均值 + GJR-GARCH(1,1)
- `TGARCH(1,1)_Const`: 常数均值 + TGARCH(1,1)

**AR均值模型组:**
- `ARCH(1)_AR`: AR均值 + ARCH(1)方差
- `GARCH(1,1)_AR`: AR均值 + GARCH(1,1)方差
- `EGARCH(1,1)_AR`: AR均值 + EGARCH(1,1)方差
- `GARCH-M(1,1)_AR`: AR均值-方差 + GARCH(1,1)
- `GJR-GARCH(1,1)_AR`: AR均值 + GJR-GARCH(1,1)
- `TGARCH(1,1)_AR`: AR均值 + TGARCH(1,1)

## 📊 数学模型

### GARCH(1,1)模型
```
均值方程: r_t = μ + φ₁r_{t-1} + ε_t
方差方程: σ²_t = ω + α₁ε²_{t-1} + β₁σ²_{t-1}
```

### EGARCH(1,1)模型
```
ln(σ²_t) = ω + α₁|ε_{t-1}|/σ_{t-1} + γ₁ε_{t-1}/σ_{t-1} + β₁ln(σ²_{t-1})
```

### GARCH-M模型
```
r_t = μ + λσ_t + φ₁r_{t-1} + ε_t  (均值中包含条件方差项)
```

### 价格重构
```
对数收益率: r_t = ln(P_t / P_{t-1})
价格重构: P_t = P_{t-1} * exp(r_t)
多步预测: P_{t+k} = P_{t+k-1} * exp(r_{t+k})
```

## 🛠️ 使用方法

### 基本运行
```bash
python run_arima_garch_jpy_last150test.py \
    --root_path ./dataset/ \
    --data_path sorted_output_file.csv \
    --target rate \
    --seq_len 31 \
    --step_size 1
```

### 参数说明
- `--root_path`: 数据文件根目录
- `--data_path`: 数据文件名 (CSV格式)
- `--target`: 目标变量列名 (汇率列)
- `--seq_len`: 滚动窗口大小 (默认31)
- `--step_size`: 滚动步长 (默认1)

## 📁 输出结果

### 目录结构
每个配置和预测步长会创建独立的结果目录：

**Constant均值模型:**
```
arima_garch_results_logret_USDJPY_constant_seq31_1step_last150test/
arima_garch_results_logret_USDJPY_constant_seq31_24step_last150test/
arima_garch_results_logret_USDJPY_constant_seq31_30step_last150test/
...
```

**AR均值模型:**
```
arima_garch_results_logret_USDJPY_p1q1_seq31_1step_last150test/
arima_garch_results_logret_USDJPY_p1q1_seq31_24step_last150test/
...
```

### 文件类型

#### 1. 预测结果图表
- `plot_price_level_*.png`: 预测效果可视化
  - 总体预测趋势图
  - 局部预测细节图
  - 95%置信区间
  - 预测窗口标识

#### 2. 模型参数文件
- `model_params_*.json`: JSON格式的模型参数
```json
{
  "GARCH(1,1)_Const": {
    "model_type": "GARCH(1,1)_Const",
    "parameters": {
      "mean_equation": {"mu": 0.001234},
      "variance_equation": {"omega": 0.000001, "alpha[1]": 0.05, "beta[1]": 0.94}
    },
    "pred_len": 30
  }
}
```

#### 3. 完整结果数据
- `results_*.pkl`: Pickle格式的完整实验结果
  - 包含真实值、预测值、评估指标、执行时间、LB检验结果

#### 4. 评估指标汇总表
- `summary_table_*.csv`: CSV格式的性能指标对比表

| Model | MSE_30 | RMSE_30 | MAE_30 | MAX_AE_30 | MAPE_30 | R2_30 | Time(s)_30 |
|-------|--------|---------|--------|-----------|---------|-------|------------|
| Naive Baseline | 0.12345678 | 0.35123456 | 0.28734561 | 1.23456789 | 2.34567891% | 0.12345678 | 0.05 |
| GARCH(1,1)_Const | 0.10234567 | 0.31987654 | 0.25432189 | 1.08765432 | 2.10987654% | 0.23456789 | 15.23 |

#### 5. 误差分析图表
- `error_analysis_*.png`: 详细的误差分析图
  - 误差分布直方图
  - 实际值vs预测值散点图
  - 误差自相关函数图
  - 滚动RMSE图

## 🔍 模型诊断

### 1. Ljung-Box检验
- **目的**: 检验残差序列的自相关性
- **滞后阶数**: 5, 10, 15, 20
- **零假设**: 残差序列无自相关
- **判断**: p值 > 0.05 表示模型拟合良好

### 2. 正态性检验
- **Jarque-Bera检验**: 检验残差正态性
- **Shapiro-Wilk检验**: 小样本正态性检验

### 3. ARCH效应检验
- **方法**: 对残差平方序列进行LB检验
- **目的**: 检验是否还存在未建模的条件异方差

### 4. 残差统计特征
- 均值、标准差、偏度、峰度
- 最小值、最大值、样本数

## 📈 实验流程

### 1. 数据预处理
```python
# 加载数据
data_df = load_and_prepare_data(root_path, data_path, target_col)

# 计算对数收益率
log_return = ln(price_t / price_{t-1})

# ADF平稳性检验
perform_stationarity_test(log_returns)
```

### 2. 滚动窗口预测
```python
# 标准化
scaler = StandardScaler()
scaled_returns = scaler.fit_transform(log_returns)

# 滚动预测循环
for i in range(test_start, total_length - pred_len + 1):
    # 训练模型
    model_predictions = train_and_forecast_arima_garch(...)
    
    # 重构价格
    price_forecasts = reconstruct_prices(model_predictions)
    
    # 收集结果
    collect_results(price_forecasts, actual_prices)
```

### 3. 模型评估
```python
# 计算评估指标
mse = mean_squared_error(actual, predicted)
rmse = sqrt(mse)  
mae = mean_absolute_error(actual, predicted)
mape = mean_absolute_percentage_error(actual, predicted)
r2 = r2_score(actual, predicted)

# 模型诊断
lb_test = ljung_box_test(residuals)
normality_test = jarque_bera_test(residuals)
```

## 🎯 关键特性

### 1. 异常处理机制
- **极端值检测**: 绝对值 > 10.0 的预测被标记为异常
- **NaN/Inf处理**: 自动检测和替换无效预测
- **ARMA回退**: GARCH模型失败时自动使用ARMA模型

### 2. 多步预测策略
- **直接预测**: 使用模型的内置horizon参数
- **价格重构**: 逐步重构价格水平，避免累积误差
- **裁剪机制**: 对极端的对数收益率进行裁剪 (-5, 5)

### 3. 结果组织
- **按预测步长分组**: 每个预测步长独立运行和保存
- **模型类型分离**: Constant均值和AR均值模型分别处理
- **配置比较**: 全局最佳模型自动识别

## 📝 代码结构

### 主要函数

1. **load_and_prepare_data()**: 数据加载和预处理
2. **train_and_forecast_arima_garch()**: GARCH模型训练和预测
3. **rolling_forecast()**: 滚动窗口预测主循环
4. **evaluate_model()**: 模型性能评估
5. **plot_results()**: 结果可视化
6. **generate_summary_table()**: 汇总表格生成

### 核心改进

1. **多步预测循环**: 外层循环遍历所有预测步长
2. **独立结果目录**: 每个配置创建独立目录
3. **详细注释**: 全面的函数和代码注释
4. **增强诊断**: 更完整的模型诊断功能
5. **结果分析**: 按预测步长分组的结果总结

## 🚨 注意事项

1. **数据格式要求**:
   - CSV文件必须包含'date'和目标列
   - 数据按日期升序排列
   - 汇率数据必须为正数

2. **计算资源**:
   - 多步预测会显著增加计算时间
   - 建议在有足够内存的机器上运行
   - 可以调整seq_lens_to_test和arma_params减少计算量

3. **模型收敛**:
   - EGARCH等复杂模型可能收敛困难
   - 系统会自动回退到更简单的模型
   - 建议检查模型参数的合理性

4. **结果解释**:
   - 短期预测(1-30天)通常更准确
   - 长期预测(90-180天)主要用于趋势分析
   - 注意观察置信区间的变化

## 📊 实验建议

### 最佳实践

1. **先运行少数配置**: 测试1-2个预测步长确认系统正常
2. **检查数据质量**: 确保对数收益率序列平稳
3. **监控模型收敛**: 观察控制台输出的警告信息
4. **分析残差**: 重点关注LB检验的p值
5. **比较不同步长**: 分析预测精度随步长的衰减规律

### 参数调优

1. **seq_len**: 建议测试 [31, 62, 125] 等不同窗口大小
2. **arma_params**: 可以扩展到 [(1,0), (1,1), (2,0), (2,1)]
3. **pred_lens**: 可以根据需要调整预测步长组合
4. **fixed_test_set_size**: 可以根据数据量调整测试集大小

这个系统为时间序列预测提供了一个全面、严谨的实验框架，特别适用于金融时间序列的多步预测分析。